<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADB Bugreport & Diagnostics - Rust WebADB</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .status.disconnected {
            background: #fee;
            color: #c33;
        }

        .status.connected {
            background: #efe;
            color: #3c3;
        }

        .status.working {
            background: #ffc;
            color: #cc6;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .section {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .section h2 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section p {
            color: #666;
            margin-bottom: 15px;
        }

        .progress {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
            display: none;
        }

        .progress.show {
            display: block;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            margin-top: 15px;
        }

        .file-info {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
        }

        .file-info.show {
            display: block;
        }

        .file-info h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .file-info p {
            color: #555;
            margin: 5px 0;
        }

        .download-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            color: #856404;
        }

        .success {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            color: #155724;
        }

        .error {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            color: #721c24;
        }

        .logcat-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        .logcat-controls input {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            width: 120px;
        }

        .file-list {
            max-height: 300px;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .file-item {
            padding: 8px;
            margin: 5px 0;
            background: white;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-item:hover {
            background: #e8f4f8;
        }

        .file-icon {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß ADB Bugreport & Diagnostics</h1>
        <p class="subtitle">Generate comprehensive device reports and diagnostics</p>

        <div id="status" class="status disconnected">
            Status: Disconnected
        </div>

        <div class="controls">
            <button id="connectBtn">Connect to Device</button>
            <button id="disconnectBtn" disabled>Disconnect</button>
        </div>

        <!-- Connection Diagnostics Section -->
        <div class="section" style="background: #f0f8ff; border-left: 4px solid #2196F3;">
            <h2>üîç Connection Diagnostics</h2>
            <p>Monitor ADB connection health and manage streams.</p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
                <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div style="color: #666; font-size: 12px; margin-bottom: 5px;">Active Streams</div>
                    <div style="font-size: 28px; font-weight: bold; color: #2196F3;" id="streamCount">0</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div style="color: #666; font-size: 12px; margin-bottom: 5px;">Connection Health</div>
                    <div style="font-size: 24px; font-weight: bold; color: #999;" id="healthStatus">Unknown</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div style="color: #666; font-size: 12px; margin-bottom: 5px;">Stale Cleaned</div>
                    <div style="font-size: 28px; font-weight: bold; color: #FF9800;" id="cleanedCount">0</div>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button id="healthCheckBtn" disabled style="background: #4CAF50;">Check Health</button>
                <button id="cleanupStreamsBtn" disabled style="background: #FF9800;">Cleanup Stale</button>
                <button id="refreshDiagnosticsBtn" disabled style="background: #2196F3;">Refresh</button>
            </div>
            
            <div id="diagnosticsLog" style="margin-top: 15px; padding: 10px; background: white; border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; display: none;"></div>
        </div>

        <!-- Shell Terminal Section -->
        <div class="section" style="background: #1e1e1e; color: #d4d4d4; border-left: 4px solid #00ff00;">
            <h2 style="color: #00ff00;">üíª Shell Terminal</h2>
            <p style="color: #d4d4d4;">Execute commands on the Android device.</p>
            
            <!-- Quick Commands -->
            <div style="margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 8px;">
                <button id="shellCmdLs" style="background: #2d2d2d; color: #00ff00; border: 1px solid #00ff00; padding: 6px 12px; font-size: 12px;">ls -la</button>
                <button id="shellCmdPwd" style="background: #2d2d2d; color: #00ff00; border: 1px solid #00ff00; padding: 6px 12px; font-size: 12px;">pwd</button>
                <button id="shellCmdDf" style="background: #2d2d2d; color: #00ff00; border: 1px solid #00ff00; padding: 6px 12px; font-size: 12px;">df -h</button>
                <button id="shellCmdPs" style="background: #2d2d2d; color: #00ff00; border: 1px solid #00ff00; padding: 6px 12px; font-size: 12px;">ps</button>
                <button id="shellCmdVersion" style="background: #2d2d2d; color: #00ff00; border: 1px solid #00ff00; padding: 6px 12px; font-size: 12px;">version</button>
                <button id="shellCmdUname" style="background: #2d2d2d; color: #00ff00; border: 1px solid #00ff00; padding: 6px 12px; font-size: 12px;">uname</button>
                <button id="shellCmdClear" style="background: #2d2d2d; color: #ff6b6b; border: 1px solid #ff6b6b; padding: 6px 12px; font-size: 12px;">clear</button>
            </div>
            
            <!-- Terminal Output -->
            <div id="terminalOutput" style="
                background: #000000;
                color: #00ff00;
                font-family: 'Courier New', monospace;
                font-size: 13px;
                padding: 15px;
                border-radius: 5px;
                height: 400px;
                overflow-y: auto;
                margin-bottom: 10px;
                white-space: pre-wrap;
                word-wrap: break-word;
                border: 2px solid #00ff00;
            ">$ <span style="color: #888;">Connected. Type a command or use quick buttons above.</span></div>
            
            <!-- Command Input -->
            <div style="display: flex; gap: 10px; align-items: center;">
                <span style="color: #00ff00; font-family: 'Courier New', monospace; font-size: 14px; font-weight: bold;">$</span>
                <input 
                    type="text" 
                    id="shellInput" 
                    placeholder="Enter command (e.g., ls -la, df -h, ps)" 
                    disabled
                    style="
                        flex: 1;
                        background: #000000;
                        color: #00ff00;
                        border: 2px solid #00ff00;
                        padding: 10px;
                        font-family: 'Courier New', monospace;
                        font-size: 14px;
                        border-radius: 5px;
                    "
                />
                <button 
                    id="shellExecuteBtn" 
                    disabled
                    style="background: #00ff00; color: #000; padding: 10px 20px; font-weight: bold;">
                    Execute
                </button>
            </div>
            
            <div style="margin-top: 10px; color: #888; font-size: 12px;">
                üí° Tips: Use ‚Üë/‚Üì arrows for command history | Ctrl+C to stop | Ctrl+L to clear
            </div>
        </div>

        <!-- Bugreport Section -->
        <div class="section">
            <h2>üìã Bug Reports</h2>
            <p>Access device diagnostic reports for troubleshooting.</p>
            
            <div class="warning">
                <strong>üí° Tip:</strong> Check "Available Bugreports" below first to download existing reports instantly!
                Generating a new report takes 5-10 minutes (2-5 min generation + 1-5 min download for large files).
            </div>

            <button id="bugreportLiteBtn" disabled>Generate Lite Report (Fast ~30s)</button>
            <button id="bugreportFullBtn" disabled>Generate Full Report (Very Slow ~5-10min)</button>
            
            <div id="bugreportProgress" class="progress">
                <div id="bugreportProgressBar" class="progress-bar">0%</div>
            </div>

            <div id="bugreportInfo" class="file-info">
                <h3>Report Generated</h3>
                <p><strong>Size:</strong> <span id="reportSize">-</span></p>
                <p><strong>Format:</strong> <span id="reportFormat">-</span></p>
                <button id="downloadReportBtn" class="download-btn">Download Report</button>
                <button id="viewReportBtn">View Report</button>
            </div>

            <div id="bugreportOutput" class="output" style="display: none;"></div>

            <!-- Available Bugreports -->
            <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #eee; background: #f9f9f9; padding: 20px; border-radius: 8px;">
                <h3>‚ö° Available Bugreports on Device (Recommended)</h3>
                <p style="color: #666; margin-bottom: 15px;">
                    <strong>Fastest option:</strong> Download previously generated bugreports instantly.<br>
                    If you recently ran "adb bugreportz" or generated a report, it will appear here.
                </p>
                <button id="listBugreportsBtn" disabled style="background: #4CAF50;">List Available Bugreports</button>
                <div id="bugreportsList" class="output" style="display: none;"></div>
                
                <!-- Download Debug Panel -->
                <div id="downloadDebug" style="display: none; margin-top: 20px; padding: 15px; background: #f0f0f0; border-radius: 8px; font-family: monospace; font-size: 12px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <strong style="color: #2196F3;">üìä Download Progress</strong>
                        <span id="downloadStatus" style="color: #666;">Idle</span>
                    </div>
                    <div style="margin: 10px 0;">
                        <div style="background: #ddd; border-radius: 10px; height: 20px; overflow: hidden;">
                            <div id="downloadProgressBar" style="background: linear-gradient(90deg, #4CAF50, #45a049); height: 100%; width: 0%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 11px;"></div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <div>üìÅ <strong>File:</strong> <span id="debugFile">-</span></div>
                        <div>üì¶ <strong>Size:</strong> <span id="debugSize">-</span></div>
                        <div>‚è±Ô∏è <strong>Elapsed:</strong> <span id="debugTime">0s</span></div>
                        <div>‚ö° <strong>Speed:</strong> <span id="debugSpeed">-</span></div>
                    </div>
                    <div style="margin-top: 10px; padding: 8px; background: white; border-radius: 4px;">
                        <div style="color: #666; font-size: 11px; margin-bottom: 5px;">Console Log:</div>
                        <div id="debugLog" style="max-height: 100px; overflow-y: auto; color: #333;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logcat Section -->
        <div class="section">
            <h2>üìù Logcat</h2>
            <p>View device logs for debugging and troubleshooting.</p>

            <div class="logcat-controls">
                <input type="number" id="logcatLines" value="100" min="10" max="10000" placeholder="Lines">
                <button id="logcatBtn" disabled>Get Logcat</button>
                <button id="logcatClearBtn" disabled>Clear Logcat</button>
                <button id="downloadLogBtn" class="download-btn" disabled>Download Log</button>
            </div>

            <div id="logcatOutput" class="output"></div>
        </div>

        <!-- File Browser Section -->
        <div class="section">
            <h2>üìÅ File Browser</h2>
            <p>Browse and download files from your device.</p>

            <div class="logcat-controls">
                <input type="text" id="filePath" value="/sdcard" placeholder="Path">
                <button id="listBtn" disabled>List Directory</button>
                <button id="statBtn" disabled>Get File Info</button>
            </div>

            <div id="fileList" class="file-list" style="display: none;"></div>
            
            <div id="fileStatOutput" class="output" style="display: none;"></div>
        </div>

        <!-- Screen Recording (future) -->
        <div class="section">
            <h2>üé• Advanced Operations</h2>
            <p>Additional diagnostic and data collection tools.</p>

            <button id="screenshotBtn" disabled>Capture Screenshot</button>
            <button id="dumpStateBtn" disabled>Dump System State</button>
            <button id="packageListBtn" disabled>List All Packages</button>
            
            <div id="advancedOutput" class="output"></div>
        </div>
    </div>

    <script type="module">
        import init, { Adb, generate_keypair, has_keypair } from './pkg/webadb_rs.js';

        let adb = null;
        let currentReport = null;
        let currentLog = null;
        
        // Shell state
        let commandHistory = [];
        let historyIndex = -1;
        let isExecuting = false;

        // Shell functions
        async function executeShellCommand() {
            const input = document.getElementById('shellInput');
            const output = document.getElementById('terminalOutput');
            const command = input.value.trim();
            
            if (!command || isExecuting) return;
            
            // Add to history
            if (commandHistory.length === 0 || commandHistory[commandHistory.length - 1] !== command) {
                commandHistory.push(command);
            }
            historyIndex = commandHistory.length;
            
            // Display command
            appendTerminal(`$ ${command}\n`, '#00ff00');
            input.value = '';
            input.disabled = true;
            isExecuting = true;
            
            try {
                const result = await adb.shell(command);
                appendTerminal(result + '\n', '#d4d4d4');
            } catch (error) {
                appendTerminal(`Error: ${error}\n`, '#ff6b6b');
            } finally {
                input.disabled = false;
                input.focus();
                isExecuting = false;
            }
        }
        
        function executeQuickCommand(command) {
            const input = document.getElementById('shellInput');
            input.value = command;
            executeShellCommand();
        }
        
        function appendTerminal(text, color = '#d4d4d4') {
            const output = document.getElementById('terminalOutput');
            const span = document.createElement('span');
            span.style.color = color;
            span.textContent = text;
            output.appendChild(span);
            output.scrollTop = output.scrollHeight;
        }
        
        function clearTerminal() {
            const output = document.getElementById('terminalOutput');
            output.innerHTML = '$ <span style="color: #888;">Terminal cleared. Ready for commands.</span>';
        }
        
        function handleShellKeydown(event) {
            const input = document.getElementById('shellInput');
            
            // Enter key
            if (event.key === 'Enter') {
                event.preventDefault();
                executeShellCommand();
                return;
            }
            
            // Up arrow - previous command
            if (event.key === 'ArrowUp') {
                event.preventDefault();
                if (historyIndex > 0) {
                    historyIndex--;
                    input.value = commandHistory[historyIndex];
                }
                return;
            }
            
            // Down arrow - next command
            if (event.key === 'ArrowDown') {
                event.preventDefault();
                if (historyIndex < commandHistory.length - 1) {
                    historyIndex++;
                    input.value = commandHistory[historyIndex];
                } else {
                    historyIndex = commandHistory.length;
                    input.value = '';
                }
                return;
            }
            
            // Ctrl+C - clear input
            if (event.ctrlKey && event.key === 'c') {
                event.preventDefault();
                input.value = '';
                return;
            }
            
            // Ctrl+L - clear terminal
            if (event.ctrlKey && event.key === 'l') {
                event.preventDefault();
                clearTerminal();
                return;
            }
        }

        async function main() {
            await init();

            if (!await has_keypair()) {
                await generate_keypair();
            }

            adb = new Adb();

            setupEventListeners();
        }

        function setupEventListeners() {
            document.getElementById('connectBtn').addEventListener('click', connect);
            document.getElementById('disconnectBtn').addEventListener('click', disconnect);
            
            // Diagnostics
            document.getElementById('healthCheckBtn').addEventListener('click', performHealthCheck);
            document.getElementById('cleanupStreamsBtn').addEventListener('click', cleanupStaleStreams);
            document.getElementById('refreshDiagnosticsBtn').addEventListener('click', refreshDiagnostics);
            
            // Bugreport
            document.getElementById('bugreportLiteBtn').addEventListener('click', generateLiteBugreport);
            document.getElementById('bugreportFullBtn').addEventListener('click', generateFullBugreport);
            document.getElementById('downloadReportBtn').addEventListener('click', downloadReport);
            document.getElementById('viewReportBtn').addEventListener('click', viewReport);
            document.getElementById('listBugreportsBtn').addEventListener('click', listAvailableBugreports);
            
            // Logcat
            document.getElementById('logcatBtn').addEventListener('click', getLogcat);
            document.getElementById('logcatClearBtn').addEventListener('click', clearLogcat);
            document.getElementById('downloadLogBtn').addEventListener('click', downloadLog);
            
            // Files
            document.getElementById('listBtn').addEventListener('click', listDirectory);
            document.getElementById('statBtn').addEventListener('click', statFile);
            
            // Advanced
            document.getElementById('screenshotBtn').addEventListener('click', captureScreenshot);
            document.getElementById('dumpStateBtn').addEventListener('click', dumpState);
            document.getElementById('packageListBtn').addEventListener('click', listPackages);
            
            // Shell
            document.getElementById('shellInput').addEventListener('keydown', handleShellKeydown);
            document.getElementById('shellExecuteBtn').addEventListener('click', executeShellCommand);
            
            // Shell quick commands
            document.getElementById('shellCmdLs').addEventListener('click', () => executeQuickCommand('ls -la'));
            document.getElementById('shellCmdPwd').addEventListener('click', () => executeQuickCommand('pwd'));
            document.getElementById('shellCmdDf').addEventListener('click', () => executeQuickCommand('df -h'));
            document.getElementById('shellCmdPs').addEventListener('click', () => executeQuickCommand('ps'));
            document.getElementById('shellCmdVersion').addEventListener('click', () => executeQuickCommand('getprop | grep version'));
            document.getElementById('shellCmdUname').addEventListener('click', () => executeQuickCommand('uname -a'));
            document.getElementById('shellCmdClear').addEventListener('click', clearTerminal);
        }

        async function connect() {
            try {
                updateStatus('working', 'Connecting...');
                await adb.connect();
                updateStatus('connected', 'Connected');
                enableButtons();
                await refreshDiagnostics();
                
                // Show terminal welcome
                clearTerminal();
                appendTerminal('='.repeat(60) + '\n', '#00ff00');
                appendTerminal('  Android Device Shell - WebADB\n', '#00ff00');
                appendTerminal('='.repeat(60) + '\n', '#00ff00');
                
                try {
                    const props = await adb.get_properties();
                    appendTerminal(`\n Device: ${props['ro.product.model'] || 'Unknown'}\n`, '#d4d4d4');
                    appendTerminal(` Android: ${props['ro.build.version.release'] || 'Unknown'}\n`, '#d4d4d4');
                    appendTerminal(` Build: ${props['ro.build.id'] || 'Unknown'}\n\n`, '#d4d4d4');
                } catch (e) {
                    appendTerminal('\n Device connected!\n\n', '#d4d4d4');
                }
                
                appendTerminal('$ ', '#00ff00');
            } catch (error) {
                updateStatus('disconnected', 'Connection failed');
                alert('Failed to connect: ' + error);
            }
        }

        async function disconnect() {
            try {
                await adb.disconnect();
                updateStatus('disconnected', 'Disconnected');
                disableButtons();
            } catch (error) {
                alert('Failed to disconnect: ' + error);
            }
        }

        // Diagnostics functions
        async function refreshDiagnostics() {
            try {
                const count = adb.active_stream_count();
                document.getElementById('streamCount').textContent = count;
                
                const log = document.getElementById('diagnosticsLog');
                log.style.display = 'block';
                const time = new Date().toLocaleTimeString();
                log.innerHTML = `<div style="color: #2196F3;">[${time}] Refreshed - ${count} active stream(s)</div>` + log.innerHTML;
            } catch (error) {
                showError('Refresh failed: ' + error);
            }
        }
        
        async function performHealthCheck() {
            const btn = document.getElementById('healthCheckBtn');
            const status = document.getElementById('healthStatus');
            const log = document.getElementById('diagnosticsLog');
            
            try {
                btn.disabled = true;
                btn.textContent = 'Checking...';
                status.textContent = '...';
                status.style.color = '#FF9800';
                
                const healthy = await adb.health_check();
                
                const time = new Date().toLocaleTimeString();
                log.style.display = 'block';
                
                if (healthy) {
                    status.textContent = '‚úì Healthy';
                    status.style.color = '#4CAF50';
                    log.innerHTML = `<div style="color: #4CAF50;">[${time}] Health check PASSED</div>` + log.innerHTML;
                    showSuccess('Device is responding');
                } else {
                    status.textContent = '‚úó Unhealthy';
                    status.style.color = '#f44336';
                    log.innerHTML = `<div style="color: #f44336;">[${time}] Health check FAILED</div>` + log.innerHTML;
                    showWarning('Device not responding properly');
                }
                
                await refreshDiagnostics();
            } catch (error) {
                status.textContent = '‚úó Error';
                status.style.color = '#f44336';
                showError('Health check error: ' + error);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Check Health';
            }
        }
        
        async function cleanupStaleStreams() {
            const btn = document.getElementById('cleanupStreamsBtn');
            const countEl = document.getElementById('cleanedCount');
            const log = document.getElementById('diagnosticsLog');
            
            try {
                btn.disabled = true;
                btn.textContent = 'Cleaning...';
                
                const cleaned = await adb.cleanup_stale_streams();
                const total = parseInt(countEl.textContent) + cleaned;
                countEl.textContent = total;
                
                const time = new Date().toLocaleTimeString();
                log.style.display = 'block';
                log.innerHTML = `<div style="color: #FF9800;">[${time}] Cleaned ${cleaned} stale stream(s)</div>` + log.innerHTML;
                
                if (cleaned > 0) {
                    showSuccess(`Cleaned ${cleaned} stale stream(s)`);
                } else {
                    showSuccess('No stale streams found');
                }
                
                await refreshDiagnostics();
            } catch (error) {
                showError('Cleanup failed: ' + error);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Cleanup Stale';
            }
        }

        async function generateLiteBugreport() {
            const btn = document.getElementById('bugreportLiteBtn');
            const output = document.getElementById('bugreportOutput');
            const info = document.getElementById('bugreportInfo');
            
            try {
                btn.disabled = true;
                btn.textContent = 'Generating...';
                output.style.display = 'block';
                output.textContent = 'Generating lite bugreport...';
                
                const report = await adb.bugreport_lite();
                
                currentReport = new Blob([report], { type: 'text/plain' });
                
                output.textContent = report;
                info.classList.add('show');
                document.getElementById('reportSize').textContent = formatBytes(report.length);
                document.getElementById('reportFormat').textContent = 'Text';
                
                showSuccess('Lite bugreport generated successfully!');
            } catch (error) {
                output.textContent = 'Error: ' + error;
                showError('Failed to generate bugreport: ' + error);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Generate Lite Report (Fast)';
            }
        }

        async function generateFullBugreport() {
            const btn = document.getElementById('bugreportFullBtn');
            const progress = document.getElementById('bugreportProgress');
            const progressBar = document.getElementById('bugreportProgressBar');
            const output = document.getElementById('bugreportOutput');
            const info = document.getElementById('bugreportInfo');
            
            try {
                btn.disabled = true;
                btn.textContent = 'Generating... (this may take 2-5 minutes)';
                progress.classList.add('show');
                progressBar.style.width = '10%';
                progressBar.textContent = '10%';
                output.style.display = 'none';
                
                showWarning('Generating full bugreport. This can take several minutes. Please wait...');
                
                // Simulate progress (we can't get real progress from ADB)
                const progressInterval = setInterval(() => {
                    const current = parseInt(progressBar.style.width);
                    if (current < 90) {
                        const next = current + 5;
                        progressBar.style.width = next + '%';
                        progressBar.textContent = next + '%';
                    }
                }, 3000);
                
                const reportData = await adb.bugreport();
                
                clearInterval(progressInterval);
                progressBar.style.width = '100%';
                progressBar.textContent = '100%';
                
                currentReport = new Blob([reportData], { type: 'application/zip' });
                
                info.classList.add('show');
                document.getElementById('reportSize').textContent = formatBytes(reportData.byteLength);
                document.getElementById('reportFormat').textContent = 'ZIP Archive';
                
                showSuccess('Full bugreport generated successfully!');
                
                setTimeout(() => {
                    progress.classList.remove('show');
                }, 2000);
            } catch (error) {
                showError('Failed to generate bugreport: ' + error);
                progress.classList.remove('show');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Generate Full Report (Slow)';
            }
        }

        function downloadReport() {
            if (!currentReport) return;
            
            const url = URL.createObjectURL(currentReport);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'bugreport-' + new Date().getTime() + 
                         (currentReport.type.includes('zip') ? '.zip' : '.txt');
            a.click();
            URL.revokeObjectURL(url);
        }

        function viewReport() {
            const output = document.getElementById('bugreportOutput');
            if (currentReport && currentReport.type === 'text/plain') {
                output.style.display = 'block';
                currentReport.text().then(text => {
                    output.textContent = text;
                });
            } else {
                alert('Binary reports cannot be viewed in browser. Please download.');
            }
        }

        async function listAvailableBugreports() {
            const btn = document.getElementById('listBugreportsBtn');
            const output = document.getElementById('bugreportsList');
            
            try {
                btn.disabled = true;
                btn.textContent = 'Searching...';
                output.style.display = 'block';
                output.textContent = 'Searching for bugreports on device...';
                
                const paths = await adb.list_bugreports();
                
                if (paths.length === 0) {
                    output.innerHTML = '<span style="color: #999;">No bugreports found on device.</span>';
                    showWarning('No bugreports found. Generate one first using "Generate Full Report".');
                    return;
                }
                
                let html = `<div style="color: #4CAF50; margin-bottom: 15px;">Found ${paths.length} bugreport(s):</div>`;
                
                paths.forEach((path, index) => {
                    const filename = path.split('/').pop();
                    const isZip = path.endsWith('.zip');
                    const icon = isZip ? 'üì¶' : 'üìÑ';
                    // Escape HTML attributes
                    const escapedPath = path.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    
                    html += `
                        <div style="background: #2a2a2a; margin: 10px 0; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                            <div style="color: #d4d4d4; margin-bottom: 8px;">
                                ${icon} <strong>${filename}</strong>
                            </div>
                            <div style="color: #888; font-size: 12px; margin-bottom: 10px;">
                                ${path}
                            </div>
                            <button 
                                class="download-bugreport-btn"
                                data-path="${escapedPath}"
                                style="background: #667eea; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 14px;">
                                Download
                            </button>
                        </div>
                    `;
                });
                
                output.innerHTML = html;
                
                // Attach event listeners to download buttons
                document.querySelectorAll('.download-bugreport-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        let path = this.getAttribute('data-path');
                        // Decode HTML entities
                        path = path.replace(/&quot;/g, '"').replace(/&#39;/g, "'");
                        downloadExistingBugreport(path);
                    });
                });
                
                showSuccess(`Found ${paths.length} bugreport(s) on device.`);
                
            } catch (error) {
                output.innerHTML = `<span style="color: #f44336;">Error: ${error}</span>`;
                showError('Failed to list bugreports: ' + error);
            } finally {
                btn.disabled = false;
                btn.textContent = 'List Available Bugreports';
            }
        }

        async function downloadExistingBugreport(path) {
            const filename = path.split('/').pop();
            const debugPanel = document.getElementById('downloadDebug');
            const debugStatus = document.getElementById('downloadStatus');
            const debugFile = document.getElementById('debugFile');
            const debugSize = document.getElementById('debugSize');
            const debugTime = document.getElementById('debugTime');
            const debugSpeed = document.getElementById('debugSpeed');
            const debugLog = document.getElementById('debugLog');
            const progressBar = document.getElementById('downloadProgressBar');
            
            function addLog(msg) {
                const time = new Date().toLocaleTimeString();
                debugLog.innerHTML += `<div>[${time}] ${msg}</div>`;
                debugLog.scrollTop = debugLog.scrollHeight;
                console.log(`[Download] ${msg}`);
            }
            
            try {
                // Show debug panel
                debugPanel.style.display = 'block';
                debugStatus.textContent = 'Starting...';
                debugStatus.style.color = '#FF9800';
                debugFile.textContent = filename;
                debugSize.textContent = '...';
                debugTime.textContent = '0s';
                debugSpeed.textContent = '...';
                debugLog.innerHTML = '';
                progressBar.style.width = '0%';
                progressBar.textContent = '';
                
                addLog(`Starting download: ${filename}`);
                addLog(`Path: ${path}`);
                
                showWarning(`Downloading ${filename}... Please wait.`);
                
                const startTime = Date.now();
                debugStatus.textContent = 'Downloading...';
                debugStatus.style.color = '#2196F3';
                progressBar.style.width = '30%';
                progressBar.textContent = '30%';
                
                // Start timer
                const timerInterval = setInterval(() => {
                    const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
                    debugTime.textContent = elapsed + 's';
                }, 100);
                
                addLog('Requesting file from device...');
                
                const data = await adb.download_bugreport(path);
                
                clearInterval(timerInterval);
                
                const endTime = Date.now();
                const duration = ((endTime - startTime) / 1000).toFixed(1);
                const sizeStr = formatBytes(data.byteLength);
                const speed = formatBytes(data.byteLength / (duration || 1)) + '/s';
                
                debugSize.textContent = sizeStr;
                debugTime.textContent = duration + 's';
                debugSpeed.textContent = speed;
                progressBar.style.width = '100%';
                progressBar.textContent = '100%';
                
                addLog(`Download complete!`);
                addLog(`Size: ${sizeStr} (${data.byteLength} bytes)`);
                addLog(`Duration: ${duration}s`);
                addLog(`Average speed: ${speed}`);
                
                debugStatus.textContent = 'Saving...';
                debugStatus.style.color = '#4CAF50';
                
                const blob = new Blob([data], { 
                    type: path.endsWith('.zip') ? 'application/zip' : 'text/plain' 
                });
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
                
                debugStatus.textContent = 'Complete ‚úì';
                debugStatus.style.color = '#4CAF50';
                addLog('File saved successfully!');
                
                showSuccess(`Downloaded ${filename} (${sizeStr}) in ${duration}s at ${speed}`);
                
                // Hide debug panel after 5 seconds
                setTimeout(() => {
                    debugPanel.style.display = 'none';
                }, 5000);
                
            } catch (error) {
                debugStatus.textContent = 'Failed ‚úó';
                debugStatus.style.color = '#f44336';
                progressBar.style.width = '100%';
                progressBar.style.background = '#f44336';
                progressBar.textContent = 'ERROR';
                
                addLog(`ERROR: ${error}`);
                console.error(`[Download] Failed:`, error);
                showError(`Failed to download ${filename}: ${error}`);
            }
        }

        async function getLogcat() {
            const lines = parseInt(document.getElementById('logcatLines').value);
            const output = document.getElementById('logcatOutput');
            const downloadBtn = document.getElementById('downloadLogBtn');
            
            try {
                output.textContent = 'Fetching logcat...';
                const log = await adb.logcat(lines);
                currentLog = log;
                output.textContent = log;
                downloadBtn.disabled = false;
            } catch (error) {
                output.textContent = 'Error: ' + error;
                showError('Failed to get logcat: ' + error);
            }
        }

        async function clearLogcat() {
            try {
                await adb.logcat_clear();
                document.getElementById('logcatOutput').textContent = 'Logcat cleared.';
                showSuccess('Logcat buffer cleared');
            } catch (error) {
                showError('Failed to clear logcat: ' + error);
            }
        }

        function downloadLog() {
            if (!currentLog) return;
            
            const blob = new Blob([currentLog], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'logcat-' + new Date().getTime() + '.txt';
            a.click();
            URL.revokeObjectURL(url);
        }

        async function listDirectory() {
            const path = document.getElementById('filePath').value;
            const fileList = document.getElementById('fileList');
            
            try {
                fileList.innerHTML = 'Loading...';
                fileList.style.display = 'block';
                
                const entries = await adb.list_directory(path);
                
                fileList.innerHTML = '';
                entries.forEach(entry => {
                    const div = document.createElement('div');
                    div.className = 'file-item';
                    
                    const icon = entry.is_directory ? 'üìÅ' : 'üìÑ';
                    const size = entry.is_directory ? '' : ` (${formatBytes(entry.size)})`;
                    
                    div.innerHTML = `
                        <span><span class="file-icon">${icon}</span>${entry.name}${size}</span>
                        <button onclick="pullFile('${path}/${entry.name}')">Download</button>
                    `;
                    
                    fileList.appendChild(div);
                });
            } catch (error) {
                fileList.textContent = 'Error: ' + error;
                showError('Failed to list directory: ' + error);
            }
        }

        async function statFile() {
            const path = document.getElementById('filePath').value;
            const output = document.getElementById('fileStatOutput');
            
            try {
                output.style.display = 'block';
                output.textContent = 'Getting file info...';
                
                const stat = await adb.stat_file(path);
                
                output.textContent = `File: ${path}
Type: ${stat.is_directory ? 'Directory' : 'File'}
Size: ${formatBytes(stat.size)}
Mode: ${stat.mode.toString(8)}
Modified: ${new Date(stat.mtime * 1000).toLocaleString()}`;
            } catch (error) {
                output.textContent = 'Error: ' + error;
                showError('Failed to stat file: ' + error);
            }
        }

        window.pullFile = async function(path) {
            try {
                showWarning('Downloading file: ' + path);
                const data = await adb.pull_file(path);
                
                const blob = new Blob([data]);
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = path.split('/').pop();
                a.click();
                URL.revokeObjectURL(url);
                
                showSuccess('File downloaded successfully');
            } catch (error) {
                showError('Failed to pull file: ' + error);
            }
        };

        async function captureScreenshot() {
            const output = document.getElementById('advancedOutput');
            try {
                output.textContent = 'Capturing screenshot...';
                const result = await adb.shell('screencap -p /sdcard/screenshot.png && echo "Screenshot saved to /sdcard/screenshot.png"');
                output.textContent = result;
                showSuccess('Screenshot captured! Pull /sdcard/screenshot.png to download');
            } catch (error) {
                output.textContent = 'Error: ' + error;
            }
        }

        async function dumpState() {
            const output = document.getElementById('advancedOutput');
            try {
                output.textContent = 'Dumping system state...';
                const result = await adb.shell('dumpsys -l');
                output.textContent = result;
            } catch (error) {
                output.textContent = 'Error: ' + error;
            }
        }

        async function listPackages() {
            const output = document.getElementById('advancedOutput');
            try {
                output.textContent = 'Listing packages...';
                const result = await adb.shell('pm list packages');
                output.textContent = result;
            } catch (error) {
                output.textContent = 'Error: ' + error;
            }
        }

        function updateStatus(state, text) {
            const statusEl = document.getElementById('status');
            statusEl.className = 'status ' + state;
            statusEl.textContent = 'Status: ' + text;
        }

        function enableButtons() {
            document.querySelectorAll('button:not(#connectBtn)').forEach(btn => {
                if (btn.id !== 'downloadReportBtn' && btn.id !== 'viewReportBtn' && btn.id !== 'downloadLogBtn') {
                    btn.disabled = false;
                }
            });
            document.getElementById('connectBtn').disabled = true;
            
            // Enable shell
            document.getElementById('shellInput').disabled = false;
            document.getElementById('shellExecuteBtn').disabled = false;
            document.getElementById('shellInput').focus();
        }

        function disableButtons() {
            document.querySelectorAll('button:not(#connectBtn)').forEach(btn => {
                btn.disabled = true;
            });
            document.getElementById('connectBtn').disabled = false;
            
            // Disable shell
            document.getElementById('shellInput').disabled = true;
            document.getElementById('shellExecuteBtn').disabled = true;
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function showSuccess(message) {
            showMessage(message, 'success');
        }

        function showWarning(message) {
            showMessage(message, 'warning');
        }

        function showError(message) {
            showMessage(message, 'error');
        }

        function showMessage(message, type) {
            const div = document.createElement('div');
            div.className = type;
            div.textContent = message;
            document.querySelector('.container').insertBefore(
                div, 
                document.querySelector('.section')
            );
            setTimeout(() => div.remove(), 5000);
        }

        main().catch(console.error);
    </script>
</body>
</html>